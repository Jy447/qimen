# 奇门遁甲排盘系统

基于 Node.js 的**时家拆补转盘**奇门遁甲排盘系统。

## 快速开始

```bash
pnpm install
pnpm start
# 浏览器访问 http://localhost:3000
```

Docker:

```bash
docker build -t qimen . && docker run -p 3000:3000 qimen
```

## 技术栈

| 类型 | 技术 |
|------|------|
| 后端 | Node.js + Express |
| 模板 | EJS |
| 前端 | Bootstrap 3 |
| 历法 | lunar-javascript |

---

## 项目结构

```
qimen/
├── app.js                  # Express 应用入口，3个路由 (/, /custom, /api/qimen)
├── lib/
│   ├── qimen.js            # 核心排盘主流程 + 局数计算 + 天盘计算
│   ├── dipan.js            # 地盘：三奇六仪按转盘法排布
│   ├── jiuxing.js          # 九星：沿洛书环转动
│   ├── bamen.js            # 八门：按九宫数字顺序走时辰差
│   ├── bashen.js           # 八神：从值符落宫顺/逆排列
│   └── constants.js        # 常量：五行属性、九宫方位等
├── views/
│   ├── index.html          # 主页面（九宫格 + 分析面板）
│   └── standardGongTemplate.ejs  # 单宫模板
├── public/
│   ├── css/                # 样式
│   └── js/                 # 前端脚本
└── Dockerfile
```

---

## 排盘方法：时家拆补转盘

本系统采用**时家拆补法**确定局数，**转盘法**排布天盘、九星、八门。

### 转盘 vs 飞盘的区别

| 项目 | 转盘 | 飞盘 |
|------|------|------|
| 地盘排法 | 按宫数顺序 1→2→3→...→9 | 按洛书飞宫 1→8→3→4→9→2→7→6 |
| 天盘/九星转动 | 8个外宫作为整体环形转动 | 各自飞入不同宫位 |
| 八门转动 | 按九宫数字顺序数时辰差 | 与九星同步飞布 |

---

## 核心算法详解

### 排盘总流程 (`qimen.js` → `calculate()`)

```
输入日期时间
    │
    ├─ 1. 四柱（年月日时干支）
    ├─ 2. 局数（拆补法定三元 + 节气查表）
    ├─ 3. 旬首六仪（时干支所属旬→对应六仪）
    ├─ 4. 地盘（dipan.js：按局数 + 转盘法排布）
    ├─ 5. 天盘（qimen.js：地盘干沿洛书环转动）
    ├─ 6. 九星（jiuxing.js：九星沿洛书环转动，步数同天盘）
    ├─ 7. 八门（bamen.js：按九宫数字顺序走时辰差步数）
    ├─ 8. 八神（bashen.js：从值符落宫顺/逆时针排列）
    ├─ 9. 暗干、空亡、驿马
    └─ 10. 吉凶分析
```

---

### 第1步：局数确定 — 拆补法 (`qimen.js` → `calculateJuShu()`)

#### 1.1 确定节气

用 `lunar.getPrevJieQi(true)` 获取当前日期之前最近的节气（含当日）。

#### 1.2 拆补法定三元（上中下元）

**拆补法的核心**：用日干支在六十甲子中的位置找到其所属的**符头**（天干为甲或己的日子，每5天一个），由符头的序号确定三元。

```javascript
// 六十甲子序号 (0-59)
const idx = ganZhiIndex(dayGanZhi);
// 符头 = 最近的甲/己日（每5天为一个符头周期）
const fuTouIdx = idx - (idx % 5);
// 三元 = 符头序号 / 5 对 3 取模
const yuan = Math.floor(fuTouIdx / 5) % 3;  // 0=上元, 1=中元, 2=下元
```

12个符头按顺序循环：上元→中元→下元→上元→中元→下元→...

| 符头 | 甲子 | 己巳 | 甲戌 | 己卯 | 甲申 | 己丑 | 甲午 | 己亥 | 甲辰 | 己酉 | 甲寅 | 己未 |
|------|------|------|------|------|------|------|------|------|------|------|------|------|
| 三元 | 上 | 中 | 下 | 上 | 中 | 下 | 上 | 中 | 下 | 上 | 中 | 下 |

#### 1.3 查表得局数

从节气映射表 `JIE_QI_JU_SUAN` 中查找当前节气，得到阴阳遁类型和局数：

```
numbers 字符串的3位分别对应：上元局数、中元局数、下元局数
例：冬至 '174' → 上元1局, 中元7局, 下元4局
```

**阳遁（冬至→夏至）：**
```
冬至/惊蛰 174  小寒 285  大寒/春分 396
立春 852      雨水 963  清明/立夏 417
谷雨/小满 528  芒种 639
```

**阴遁（夏至→冬至）：**
```
夏至/白露 936  小暑 825  大暑/秋分 714
立秋 258      处暑 147  寒露/立冬 693
霜降/小雪 582  大雪 471
```

---

### 第2步：地盘 (`dipan.js` → `getDiPan()`)

地盘是固定不动的底盘，根据局数排布**三奇六仪**。

**三奇六仪顺序**：`戊 己 庚 辛 壬 癸 丁 丙 乙`

**转盘排法**：按九宫数字顺序（1→2→3→4→5→6→7→8→9）排列，不走洛书飞宫。

- **阳遁**：戊从局数宫开始，按宫数**递增**
- **阴遁**：戊从局数宫开始，按宫数**递减**

**示例 — 阳遁1局**：

```
戊从1宫开始，按 1→2→3→4→5→6→7→8→9 排布：

巽4:辛 | 离9:乙 | 坤2:己
震3:庚 | 中5:壬 | 兑7:丁
艮8:丙 | 坎1:戊 | 乾6:癸
```

**示例 — 阴遁9局**：

```
戊从9宫开始，按 9→8→7→6→5→4→3→2→1 排布：

巽4:癸 | 离9:戊 | 坤2:丙
震3:丁 | 中5:壬 | 兑7:庚
艮8:己 | 坎1:乙 | 乾6:辛
```

---

### 第3步：值符与值使的确定

#### 值符（九星之首）

1. 找到**旬首六仪**在地盘上的宫位 → **值符宫**
2. 该宫原位的九星 → **值符星**

**旬首六仪对应**：

| 旬 | 甲子 | 甲戌 | 甲申 | 甲午 | 甲辰 | 甲寅 |
|----|------|------|------|------|------|------|
| 六仪 | 戊 | 己 | 庚 | 辛 | 壬 | 癸 |

#### 值使（八门之首）

值使门 = 值符宫原位的八门。

#### 中宫寄坤

如果旬首六仪落在中宫(5宫)，按**天禽寄坤**规则，视为在2宫(坤宫)。

---

### 第4步：天盘 (`qimen.js` → `distributeTianPan()`)

天盘 = 地盘干沿**洛书环形**转动。

**洛书环形顺序**（顺时针，8个外宫）：

```
1(坎) → 8(艮) → 3(震) → 4(巽) → 9(离) → 2(坤) → 7(兑) → 6(乾) → 回到1

     巽4 ─→ 离9 ─→ 坤2
      ↑               ↓
     震3     中5     兑7
      ↑               ↓
     艮8 ←─ 坎1 ←─ 乾6
```

**转动规则**：

1. 找值符宫在洛书环上的位置（index）
2. 找时干在地盘上的宫位（时干落宫），得其洛书环 index
3. `steps = (时干落宫index - 值符宫index + 8) % 8`
4. 每个外宫的地盘干沿环前进 steps 步
5. **阳遁和阴遁转动方向相同**（均为顺时针）
6. 中宫天盘干 = 坤2宫天盘干（寄坤）

**甲隐于六仪之下**：如果时干为甲，甲不出现在地盘上，时干落宫 = 值符宫，steps = 0（伏吟）。

---

### 第5步：九星 (`jiuxing.js` → `distributeJiuXing()`)

九星的转动与天盘**完全同步**，使用相同的 steps。

**九星原位**：

| 宫 | 1坎 | 2坤 | 3震 | 4巽 | 5中 | 6乾 | 7兑 | 8艮 | 9离 |
|----|------|------|------|------|------|------|------|------|------|
| 星 | 天蓬 | 天芮 | 天冲 | 天辅 | 天禽 | 天心 | 天柱 | 天任 | 天英 |
| 别名 | 贪狼 | 巨门 | 禄存 | 文曲 | 廉贞 | 武曲 | 破军 | 左辅 | 右弼 |
| 五行 | 水 | 土 | 木 | 木 | 土 | 金 | 金 | 土 | 火 |

**转动公式**（与天盘相同）：

```javascript
steps = (luoGongIndex - zhiFuIndex + 8) % 8;
jiuXing[ring[(i + steps) % 8]] = BASIC_XING[ring[i]];
```

**天禽寄坤**：天禽(5宫)寄坤2宫，随天芮一起转动。转动后，天芮所在宫同时携带天禽。

---

### 第6步：八门 (`bamen.js` → `distributeBaMen()`)

**八门的转动规则与九星不同！**

| 对比项 | 九星（值符） | 八门（值使） |
|--------|-------------|-------------|
| 计算路径 | 洛书环 (1→8→3→4→9→2→7→6) | 九宫数字序 (1→2→3→4→5→6→7→8→9) |
| 步数来源 | 时干在地盘上的落宫位移 | 当前时辰距旬首时辰的步数 |
| 方向 | 阴阳遁相同 | 阳遁递增，阴遁递减 |

**八门原位**：

| 宫 | 1坎 | 2坤 | 3震 | 4巽 | 5中 | 6乾 | 7兑 | 8艮 | 9离 |
|----|------|------|------|------|------|------|------|------|------|
| 门 | 休门 | 死门 | 伤门 | 杜门 | (无) | 开门 | 惊门 | 生门 | 景门 |
| 五行 | 水 | 土 | 木 | 木 | - | 金 | 金 | 土 | 火 |
| 吉凶 | 吉 | 凶 | 凶 | 凶 | - | 吉 | 凶 | 吉 | 吉 |

**算法**：

1. **计算 hourDiff**：当前时辰干支在六十甲子中的序号 - 旬首(甲X)在六十甲子中的序号（范围 0-9）
2. **值使门落宫**（按九宫数字顺序走 hourDiff 步）：
   - 阳遁：`newGong = ((值符宫 - 1 + hourDiff) % 9) + 1`
   - 阴遁：`newGong = ((值符宫 - 1 - hourDiff % 9 + 9) % 9) + 1`
   - 落在5宫则寄坤2宫
3. **整体平移**：将值使门落宫转换为洛书环上的位移步数（`ringSteps`），其他门在洛书环上同步平移

**关键点**：
- 9步走完9个宫(含中宫)回到原点，所以 hourDiff=9 时八门不动
- 八门经过中宫(5宫)时计入步数，但不停留
- 这就是为什么八门的转动结果常常与九星不同

---

### 第7步：八神 (`bashen.js` → `distributeBaShen()`)

八神从**值符落宫**开始，按固定顺序排列。

**八神顺序**：`值符 → 腾蛇 → 太阴 → 六合 → 白虎 → 玄武 → 九地 → 九天`

**方向**：
- **阳遁**：顺时针 `1→8→3→4→9→2→7→6`
- **阴遁**：逆时针 `1→6→7→2→9→4→3→8`

值符(八神)永远在值符(星)的落宫。如果值符在中宫，寄坤2宫。

| 八神 | 类型 |
|------|------|
| 值符 | 吉 |
| 腾蛇 | 凶 |
| 太阴 | 吉 |
| 六合 | 吉 |
| 白虎 | 凶 |
| 玄武 | 凶 |
| 九地 | 吉 |
| 九天 | 吉 |

---

### 其他要素

#### 暗干 (`qimen.js` → `calculateAnGan()`)

从8宫(生门原位)开始，按三奇六仪顺序排布。阳遁递增(8→9→1→2→...)，阴遁递减(8→7→6→5→...)。

#### 空亡 (`qimen.js` → `getKongWang()`)

根据时干支所属旬，找出旬中缺失的两个地支，再映射到对应宫位。

| 旬 | 甲子 | 甲戌 | 甲申 | 甲午 | 甲辰 | 甲寅 |
|----|------|------|------|------|------|------|
| 空亡 | 戌亥 | 申酉 | 午未 | 辰巳 | 寅卯 | 子丑 |

#### 驿马 (`qimen.js` → `getMaStar()`)

| 日支 | 寅午戌 | 申子辰 | 巳酉丑 | 亥卯未 |
|------|--------|--------|--------|--------|
| 马星 | 申 | 寅 | 亥 | 巳 |

---

## 九宫格布局

视图按后天八卦方位排列（南上北下）：

```
┌─────────┬─────────┬─────────┐
│  巽 4宫  │  离 9宫  │  坤 2宫  │
│  东南    │  正南    │  西南    │
├─────────┼─────────┼─────────┤
│  震 3宫  │  中 5宫  │  兑 7宫  │
│  正东    │  中宫    │  正西    │
├─────────┼─────────┼─────────┤
│  艮 8宫  │  坎 1宫  │  乾 6宫  │
│  东北    │  正北    │  西北    │
└─────────┴─────────┴─────────┘
```

每宫显示内容（从上到下）：

```
┌──────────────────┐
│ 八神    方位/五行  │
│ 八门      九星    │
│ 宫名      宫号    │
│ 天盘干    地盘干   │
│        暗干      │
└──────────────────┘
```

---

## API

### `GET /` — 实时排盘

用当前时间自动排盘，返回 HTML 页面。

### `GET /custom` — 自定义排盘

| 参数 | 类型 | 说明 |
|------|------|------|
| date | string | 日期 `YYYY-MM-DD` |
| time | string | 时间 `HH:MM` |
| method | string | `时家`/`日家`/`月家`/`年家` |
| purpose | string | `综合`/`事业`/`财运`/`婚姻`/`健康`/`学业` |

### `GET /api/qimen` — JSON API

参数同上，返回 JSON 格式的排盘数据。

---

## 各文件详细说明

### `dipan.js` — 地盘

**职责**：根据阴阳遁和局数，按转盘法排布三奇六仪到九宫。

**核心函数**：`getDiPan(type, num) → Object`

**算法**：从局数对应的宫开始，按宫数递增(阳遁)/递减(阴遁)依次放入 `戊己庚辛壬癸丁丙乙`。所有9个宫(含中宫5)都会被分配一个天干。

### `jiuxing.js` — 九星

**职责**：根据值符宫和时干落宫，计算九星在转盘上的转动结果。

**核心函数**：`distributeJiuXing(diPan, xunShou, shiGan) → Object`

**导出工具**：
- `findGanOnDiPan(diPan, gan)` — 在地盘上查找天干所在宫位（中宫寄坤2宫）
- `LUO_SHU_ORDER` — 洛书环形顺序常量 `[1,8,3,4,9,2,7,6]`
- `BASIC_XING` — 九星原位分布

**算法**：在洛书环上计算值符宫到时干落宫的步数，8颗外宫星整体平移相同步数。天禽(5宫)寄坤2宫随天芮一起转动。

### `bamen.js` — 八门

**职责**：根据值符宫、时辰差和阴阳遁，计算八门在转盘上的位置。

**核心函数**：`distributeBaMen(zhiFuGong, hourDiff, type) → Object`

**算法要点**：
1. 值使门沿**九宫数字顺序** (1→2→...→9) 走 hourDiff 步（非洛书环）
2. 中宫(5)计入步数，落在5宫则寄坤2宫
3. 得到值使门落宫后，转换为洛书环上的位移量，其他门整体平移

### `bashen.js` — 八神

**职责**：从值符落宫开始，按固定顺序排列八神。

**核心函数**：`distributeBaShen(zhiFuGong, type) → Object`

**算法**：值符(八神)在值符(星)落宫，其余7神沿洛书环顺时针(阳遁)/逆时针(阴遁)依次排列。

### `qimen.js` — 主流程

**职责**：串联所有模块，完成完整排盘。

**核心函数**：
- `calculate(date, options)` — 完整排盘入口
- `calculateJuShu(date, method)` — 拆补法定局数
- `distributeTianPan(diPan, xunShou, shiGan)` — 天盘转动
- `getXunShou(lunar, method)` — 获取旬首六仪
- `getShiGan(lunar, method)` — 获取时干
- `getHourDiff(lunar, method)` — 计算时辰距旬首的步数
- `getKongWang(lunar, method)` — 空亡地支
- `getMaStar(lunar, method)` — 驿马星

**常量定义**：
- `JIU_GONG` — 九宫信息（名称、方位、五行）
- `JIU_XING` — 九星信息（别名、五行、特征）
- `BA_MEN` — 八门信息（五行、吉凶、特征）
- `BA_SHEN` — 八神信息（吉凶、特征）
- `JIE_QI_JU_SUAN` — 24节气→局数映射表

### `constants.js` — 公共常量

提供九宫、八门、九星的基本映射和五行属性，主要供旧代码兼容使用。核心常量已迁移至 `qimen.js` 中。

---

## 许可证

MIT License
